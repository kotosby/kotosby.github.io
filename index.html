<!DOCTYPE html>
<html>
<head>
	<title>map.dev</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 100%;
			height: 100%;
		}
<!--.info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } 
.legend { text-align: left; line-height: 18px; color: #555; } 
.legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }-->
	</style>
</head>
<body>

<div id='map'></div>

<!--Datafile-->
	<script src="data/cell.js" type="text/javascript"></script>
	<script src="data/data.js" type="text/javascript"></script>
<!--Sector script-->
	<script src="src/semicircle/Semicircle.js"></script>
<!--Colormarker-->
	<script src="src/colormarker/leaflet-color-markers.js"></script>
<!--Pulseicon-->
	<script src="src/pulseicon/L.Icon.Pulse.js"></script>
	<link rel="stylesheet" href="src/pulseicon/L.Icon.Pulse.css">
<!--Zoom label-->
	<link rel="stylesheet" href="src/zoomlabel/L.Control.ZoomLabel.css">
	<script src="src/zoomlabel/L.Control.ZoomLabel.js"></script>
<!--Ruler-->
	<link rel="stylesheet" type="text/css" href="src/ruler/leaflet-ruler.css">
	<script src="src/ruler/leaflet-ruler.js"></script>
<!--Locate control-->	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js" charset="utf-8"></script>
<!--Messagebox-->	
	<link rel="stylesheet" href="src/messagebox/leaflet-messagebox.css" />-->
	<script src="src/messagebox/leaflet-messagebox.js"></script>
<!--Cluster script-->	
	<script src="src/markercluster/leaflet.markercluster.js"></script>
	<link rel="stylesheet" href="src/markercluster/MarkerCluster.css">
	<link rel="stylesheet" href="src/markercluster/MarkerCluster.Default.css">
<!--Search bar script-->
	<script src="src/search/leaflet-search.js"></script>
	<link rel="stylesheet" href="src/search/leaflet-search.css"/>
<!--Subgroup script-->	
	<script src="src/subgroup/subgroup.js"></script>
	
	<script>

	var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

	var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
		streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr}),
		satellite  = L.tileLayer(mbUrl, {id: 'mapbox.satellite',   attribution: mbAttr});	

	var map = L.map('map',{'messagebox': true, layers: [grayscale]}).setView([53.904961, 27.553263], 7);
		map.messagebox.setPosition('bottomright');
		map.messagebox.options.timeout = 900000;
		map.messagebox.show('datastamp: ' + datastamp + "<br>" + 'cellstamp : &nbsp;'+ cellstamp);
		
		map.createPane("NBIOT").style.zIndex = 410; // between overlays and shadows
		map.createPane("G900").style.zIndex = 420; // between overlays and shadows		
		map.createPane("G1800").style.zIndex = 430; // between overlays and shadows
		map.createPane("U900").style.zIndex = 440; // between overlays and shadows		
		map.createPane("U2100C2").style.zIndex = 450; // between overlays and shadows
		map.createPane("U2100C1").style.zIndex = 460; // between overlays and shadows
		map.createPane("U2100C3").style.zIndex = 470; // between overlays and shadows
		map.createPane("U2100C4").style.zIndex = 480; // between overlays and shadows
		map.createPane("RTWP").style.zIndex = 490; // between overlays and shadows

	var baseLayers = {
		"Grayscale": grayscale,
		"Streets": streets,
		"Satellite": satellite
	};
	
	var pulsingIcon = L.icon.pulse({iconSize:[5,5],color:'#ff4300'});
	
	var u2100c4rad = 22;
	var u2100c3rad = 2*u2100c4rad;
	var u2100c1rad = 3*u2100c4rad;
	var u2100c2rad = 4*u2100c4rad;
	var u900rad = 5*u2100c4rad;
	var g1800rad = 6*u2100c4rad;
	var g900rad = 7*u2100c4rad;
	var nbiotrad = 8*u2100c4rad;

	var clusterrad = 200;
	
	var highlightStyle = {
            weight: 3,
            color: '#3B555C',
            dashArray: '',
            fillOpacity: 0.6
       }

//###################################################################### MARKERCLUSTERGROUP ###############################################################################################
var cellmcg = L.markerClusterGroup({
		spiderfyOnMaxZoom: false,
		maxClusterRadius: clusterrad,
		showCoverageOnHover: false,
		zoomToBoundsOnClick: true,
		disableClusteringAtZoom: 13,
		animate: false
	}),	
    U2100FG = L.featureGroup.subGroup(cellmcg),
    U900FG= L.featureGroup.subGroup(cellmcg),
    GSMFG = L.featureGroup.subGroup(cellmcg),
    NBIOTFG = L.featureGroup.subGroup(cellmcg);
//	control = L.control.layers(null, null, { collapsed: false }),
//	i, a, title, marker;
cellmcg.addTo(map);	

var outmcg = L.markerClusterGroup({
		spiderfyOnMaxZoom: false,
		maxClusterRadius: clusterrad,
		showCoverageOnHover: false,
		zoomToBoundsOnClick: true,
		disableClusteringAtZoom: 13,
		animate: true
	}),	
    UMTSOUTFG = L.featureGroup.subGroup(outmcg),
    GSMOUTFG = L.featureGroup.subGroup(outmcg);
outmcg.addTo(map);

//###################################################################### FUNCTION ###############################################################################################

//############################################## marker on click

	function onClick(e){
	map.setView([e.latlng.lat, e.latlng.lng], 14);
	}

//############################################## highlight feature
	function highlightFeature(evt) {
        var feature = evt.target;
        feature.setStyle(highlightStyle);
        if (!L.Browser.ie && !L.Browser.opera) {
            feature.bringToFront();
        }
    }
	
//############################################## reset highlight
	function resetHighlight(evt) {
        U900layer.resetStyle(evt.target);
    }
	
//############################################## cell feature	
	function cellFeature(feature, layer) {
		var popupContent = "<mark>"+"<b>"+feature.properties.name +"</b>"+"</mark>"+"<br>"+
			"CID: "+"<b>"+feature.properties.cid+"</b>"+"<br>"+
			"SITE: "+"<b>"+feature.properties.pdn+"</b>"+"<br>"+
			"RNC: "+"<b>"+feature.properties.gpdn+"</b>"+"<br>"+
			"PSC/BCCH/PCI: "+"<b>"+feature.properties.psc_bcch_pci+"</b>"
		;
		layer.bindPopup(popupContent,{closeOnClick: false,autoClose: false});
		layer.bindTooltip(popupContent,{sticky:true});
        layer.on({
            mouseover:highlightFeature,
            mouseout:resetHighlight
       });
	}

//############################################## data feature
	function dataFeature(feature, layer) {
	
		let param;
		switch (feature.properties.fname) {
        case "rtwp": param = "RTWP: "; break;
        case "packetloss": param = "PLR: "; break;
        case "cellupdate": param = "RLC CUPD: "; break;
		case "jitter": param = "JITTER: "; break;
		default: param = "undef";}
		var popupContent = "<mark>"+"<b>"+feature.properties.name +"</b>"+"</mark>"+"<br>"+
			param +"<b>"+feature.properties.value+"</b>"+"<br>"+
			"RNC: "+"<b>"+feature.properties.gpdn+"</b>"+"<br>"+
			"RT: "+"<b>"+feature.properties.rtime+"</b>"
		;		
		layer.bindPopup(popupContent,{closeOnClick: false,autoClose: false});
		layer.bindTooltip(popupContent,{sticky:true})
	}	
	
//###################################################################### populate UMTSOUT ###############################################################################################

var umtsoutlayer =	L.geoJSON([umtsout], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},

		onEachFeature: cellFeature,
		pointToLayer: function (feature, latlng) {
		
		let radius;
		let color;
		let pane;
		switch (feature.properties.car) {
        case 10563: radius = u2100c2rad; color = '#000000'; pane = 'U2100C2'; break;
		case 10588: radius = u2100c1rad; color = '#000000'; pane = 'U2100C1'; break;
		case 10613: radius = u2100c3rad; color = '#000000'; pane = 'U2100C3'; break;
		case 10638: radius = u2100c4rad; color = '#000000'; pane = 'U2100C4'; break;
		case 3013: radius = u900rad; color = '#000000'; pane = 'U900'; break;
		default: radius = u2100c4rad; color = '#000000';}

		return L.semiCircle(latlng, {radius: radius, pane: pane, color: color})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	}).addTo(UMTSOUTFG);

//###################################################################### 

var umtsoutmarker =	L.geoJSON([umtsout], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		pointToLayer: function (feature, latlng) {
        return L.marker(latlng,{icon: redIcon, opacity: 0.3})
		.on('click', onClick)
		}
	})//.addTo(map);

//###################################################################### populate GSMOUT ###############################################################################################

var gsmoutlayer =	L.geoJSON([gsmout], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},

		onEachFeature: cellFeature,
		pointToLayer: function (feature, latlng) {
		
		let radius;
		let color;
		let pane;
		switch (feature.properties.band) {
        case 0: radius = g900rad; color = '#444444'; pane = 'G900'; break;
		case 2: radius = g1800rad; color = '#444444'; pane = 'G1800'; break;
		default: radius = g900rad; color = '#444444';}

		return L.semiCircle(latlng, {radius: radius, pane: pane, color: color})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	}).addTo(GSMOUTFG);

//######################################################################

var gsmoutmarker =	L.geoJSON([gsmout], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		pointToLayer: function (feature, latlng) {
        return L.marker(latlng,{icon: redIcon, opacity: 0.3})
		.on('click', onClick)
		}
	})//.addTo(map);

//###################################################################### populate RTWP ###############################################################################################

var RTWPlayer =	L.geoJSON([rtwp], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: dataFeature,
		pointToLayer: function (feature, latlng) {
		return L.semiCircle(latlng, {radius: feature.properties.rad, color:'#ff4300'})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	})//.addTo(map);

//###################################################################### populate RTWP PULSE ICON ###############################################################################################

var RTWPpulse =	L.geoJSON([rtwp], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
//		onEachFeature: onEachFeature,
		pointToLayer: function (feature, latlng) {
        return L.marker(latlng,{icon: pulsingIcon})
		}
	})//.addTo(map);

//###################################################################### populate PACKET LOSS ###############################################################################################

var PLRlayer =	L.geoJSON([packetloss], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: dataFeature,
		pointToLayer: function (feature, latlng) {
		let icon;
      switch (feature.properties.value) {
        case ' 100.00%': icon = blackIcon; break;
		case ' 0.22%': icon = yellowIcon; break;
		case ' 0.33%': icon = yellowIcon; break;
		case ' 0.44%': icon = orangeIcon; break;
		case ' 0.55%': icon = orangeIcon; break;
		case ' 0.66%': icon = orangeIcon; break;
		case ' 0.77%': icon = orangeIcon; break;
		case ' 0.88%': icon = orangeIcon; break;
		case ' 0.99%': icon = orangeIcon; break;
		default: icon = redIcon;}
        return L.marker(latlng,{icon: icon})		
		}
	})//.addTo(map);

//###################################################################### populate JITTER ###############################################################################################

var Jlayer =	L.geoJSON([jitter], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: dataFeature,
		pointToLayer: function (feature, latlng) {
       return L.marker(latlng,{icon: blueIcon})
		}
	})//.addTo(map);
	
//###################################################################### populate CELLUPDATE ###############################################################################################

var RLCCUPDlayer = L.geoJSON([cellupdate], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: dataFeature,
		pointToLayer: function (feature, latlng) {
        return marker = L.marker(latlng,{icon: violetIcon})
		}
	})//.addTo(map);
	
//###################################################################### populate U900 ###############################################################################################

var U900layer =	L.geoJSON([umts900], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: cellFeature,
		pointToLayer: function (feature, latlng) {
//		return L.semiCircle(latlng, {radius: feature.properties.rad, color:'#00ddff'})
		return L.semiCircle(latlng, {radius: u900rad, pane: 'U900', color:'#00ff00'})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	}).addTo(U900FG);	

//###################################################################### populate NBIOT ###############################################################################################

var NBIOTlayer =	L.geoJSON([nbiot], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: cellFeature,
		pointToLayer: function (feature, latlng) {
		return L.semiCircle(latlng, {radius: nbiotrad, pane: 'NBIOT', color:'#ff00ff'})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	}).addTo(NBIOTFG);	

//###################################################################### populate GSM ###############################################################################################

var GSMlayer =	L.geoJSON([gsm], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},
		onEachFeature: cellFeature,
		pointToLayer: function (feature, latlng) {
		
		let radius;
		let color;
		let pane;
		switch (feature.properties.band) {
        case 0: radius = g900rad; color = '#ffa500'; pane = 'G900'; break;
		case 2: radius = g1800rad; color = '#ff4300'; pane = 'G1800'; break;
		default: radius = g900rad; color = '#ffa500';}
		
		return L.semiCircle(latlng, {radius: radius, pane: pane, color: color})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	}).addTo(GSMFG);	

//###################################################################### populate U2100 ###############################################################################################

var U2100layer =	L.geoJSON([umts2100], {
		style: function (feature) {
			return feature.properties && feature.properties.style;
		},

		onEachFeature: cellFeature,
		pointToLayer: function (feature, latlng) {
		
		let radius;
		let color;
		let pane;
		switch (feature.properties.car) {
        case 10563: radius = u2100c2rad; color = '#00ddff'; pane = 'U2100C2'; break;
		case 10588: radius = u2100c1rad; color = '#00ddff'; pane = 'U2100C1'; break;
		case 10613: radius = u2100c3rad; color = '#00ddff'; pane = 'U2100C3'; break;
		case 10638: radius = u2100c4rad; color = '#00ddff'; pane = 'U2100C4'; break;
		default: radius = u2100c4rad; color = '#00ddff';}
		
		return L.semiCircle(latlng, {radius: radius, pane: pane, color: color})
		.setDirection(feature.properties.azm,feature.properties.beam)
		}
	}).addTo(U2100FG);	

//#####################################################################################################################################################################

	var imageUrl = 'http://www.meteoinfo.by/radar/UMMN/radar-map.gif',
    imageBounds = [[55.68860722, 33.18832], [ 52.00000000, 24.68986]];
	var MeteoLayer = L.imageOverlay(imageUrl, imageBounds,{opacity: 0.6})//.addTo(map);
//	map.removeLayer(MeteoLayer);
	
//#####################################################################################################################################################################
	
	var RTWPLG = L.layerGroup([RTWPlayer,RTWPpulse]).addTo(map);
	var UMTSOUTLG = L.layerGroup([UMTSOUTFG,umtsoutmarker])//.addTo(map);	
	var GSMOUTLG = L.layerGroup([GSMOUTFG,gsmoutmarker])//.addTo(map);
	
	var overlays = {
		"RTWP (dBm)": RTWPLG,
		"PLR (%)": PLRlayer,
		"RLC #": RLCCUPDlayer,
		"Jitter (ms)": Jlayer,

		"UMTS OUT": UMTSOUTLG,
		"GSM OUT": GSMOUTLG,

		"Meteo": MeteoLayer,

		"GSM": GSMFG,
		"U900": U900FG,
		"U2100": U2100FG,
		"NBIOT": NBIOTFG
	};
	
// Add layers, locate, ruler, scale, zoomlabel controls	
	L.control.layers(baseLayers, overlays, {collapsed: false}).addTo(map);
	L.control.locate({strings: {title: "Show current location", popup: "You are here."}}).addTo(map);
	L.control.ruler({position:'topleft'}).addTo(map);
	L.control.scale({imperial:false}).addTo(map);
	L.control.zoomLabel({position:'bottomleft'}).addTo(map);

// Add Search controls
var sdrlayer = L.geoJSON([sdr]);	
	
	L.control.search({
		layer: sdrlayer,
		collapsed: false,
		initial: false,
		zoom: 16,
		firstTipSubmit: true,
		delayType: 1,
		propertyName: 'name',
		textPlaceholder: 'Site...',
		marker: L.marker([0,0],{icon: L.icon.pulse({iconSize:[10,10],color:'red'})}),
	})
	.addTo(map);
	map.removeLayer(sdrlayer);
</script>
</body>
</html>
